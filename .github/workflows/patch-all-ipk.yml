name: VirtualHere Server Patcher and Key Generator

on:
  workflow_dispatch:
    inputs:
      target_sn:
        description: "请输入序列号 (用于安卓密钥模式或完整模式的初始修补)"
        required: true
        default: ""
      device_count:
        description: "请输入客户端设备数量"
        required: false
        default: "63"
      android_key_only:
        description: "是否仅生成安卓免Root密钥？"
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          # 创建工作目录和输出目录
          mkdir -p tools output/patched_binaries
          # 安装必要的工具 (upx)
          sudo apt-get update
          sudo apt-get install -y upx-ucl

      - name: Extract Activator Tools
        run: |
          # 解压 Linux 版的 activator 工具到 tools 目录
          unzip -o activator2_linux.zip -d tools/
          # 为所有文件添加执行权限
          chmod +x tools/*

      - name: Set Library Path
        run: |
          # 设置库文件搜索路径，让系统能够找到 libcrypto.so.1.1
          echo "LD_LIBRARY_PATH=$(pwd)/tools" >> $GITHUB_ENV

      - name: Generate Android Key Only Mode
        if: ${{ inputs.android_key_only }}
        run: |
          echo "运行模式: 仅生成安卓免Root密钥"
          echo "输入序列号: ${{ inputs.target_sn }}"
          echo "设备数量: ${{ inputs.device_count }}"
          
          # 切换到工具目录并运行 activator
          cd tools
          # 生成密钥并精确提取 License= 行
          ./activator android_mode ${{ inputs.device_count }} ${{ inputs.target_sn }} 2>&1 | grep "^License=" | tee ../output/android_license_key.txt
          
          # 检查是否成功生成密钥
          if [ ! -s ../output/android_license_key.txt ]; then
            echo "错误: 未能生成有效的许可证密钥！"
            echo "请检查输入的序列号是否正确，以及 activator 工具是否正常工作。"
            exit 1
          fi
          
          echo "安卓密钥已生成并保存到 output/android_license_key.txt"
          echo "生成的密钥: $(cat ../output/android_license_key.txt)"

      - name: Full Patch Mode
        if: ${{ !inputs.android_key_only }}
        run: |
          echo "运行模式: 完整修补模式"
          echo "初始修补使用的任意序列号: ${{ inputs.target_sn }}"
          echo "设备数量: ${{ inputs.device_count }}"

          # 遍历 ipk 目录下的所有文件
          for server_binary in ipk/*; do
            if [ -f "$server_binary" ]; then
              filename=$(basename "$server_binary")
              echo "正在处理文件: $filename"

              # 复制原始文件到工作区
              cp "$server_binary" .

              # 步骤 1: 尝试解压
              echo "尝试解压 $filename ..."
              if upx -d "$filename"; then
                echo "$filename 解压成功，将继续执行修补和压缩。"
                needs_repack=true
              else
                echo "$filename 解压失败（可能未压缩），将继续执行修补，但跳过压缩。"
                needs_repack=false
              fi

              # 步骤 2: 修补文件 (使用用户输入的任意SN进行初始修补)
              cd tools
              ./activator "../$filename" ${{ inputs.device_count }} ${{ inputs.target_sn }}
              cd ..

              # 步骤 3: 如果解压成功，则重新压缩
              if [ "$needs_repack" = true ]; then
                echo "重新压缩 $filename ..."
                upx -9 "$filename"
              fi

              # 将处理后的文件移动到输出目录
              mv "$filename" output/patched_binaries/
              echo "已处理完成: $filename"
            fi
          done

          # 为完整模式生成一个示例密钥（使用相同的任意SN）
          cd tools
          ./activator full_mode_example ${{ inputs.device_count }} ${{ inputs.target_sn }} 2>&1 | grep "^License=" | tee ../output/full_mode_license_example.txt
          cd ..
          echo "完整模式示例密钥: $(cat output/full_mode_license_example.txt)"

      - name: Upload Patched Binaries (Full Mode)
        if: ${{ !inputs.android_key_only }}
        uses: actions/upload-artifact@v4
        with:
          name: Patched-Server-Binaries
          path: output/patched_binaries/

      - name: Upload Full Mode Example Key
        if: ${{ !inputs.android_key_only }}
        uses: actions/upload-artifact@v4
        with:
          name: Full-Mode-License-Example
          path: output/full_mode_license_example.txt

      - name: Upload Android License Key
        if: ${{ inputs.android_key_only }}
        uses: actions/upload-artifact@v4
        with:
          name: Android-License-Key
          path: output/android_license_key.txt

      - name: Show Output Info
        run: |
          if ${{ inputs.android_key_only }}; then
            echo "工作流完成！请从 Artifacts 下载 Android-License-Key 获取您的许可证密钥。"
            echo "生成的密钥内容：$(cat output/android_license_key.txt)"
          else
            echo "工作流完成！请从 Artifacts 下载："
            echo "1. Patched-Server-Binaries - 所有已修补的服务器文件"
            echo "2. Full-Mode-License-Example - 完整模式示例密钥"
            echo "请注意：完整修补模式使用的是您输入的任意序列号进行的基础修补。"
            echo "后续仍需在客户端中查看真实SN，并再次生成密钥进行激活。"
            echo "示例密钥：$(cat output/full_mode_license_example.txt)"
          fi
