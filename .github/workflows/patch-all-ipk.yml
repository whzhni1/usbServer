name: Patch VirtualHere USB Server

on:
  workflow_dispatch:
    inputs:
      serial_number:
        description: 'Serial Number (e.g., 123456789abcdef)'
        required: true
        type: string
      device_count:
        description: 'Number of devices (1-64)'
        required: false
        default: '63'
        type: string

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  patch-and-upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        # è§£åŽ‹å·¥å…·åŒ…
        unzip activator_linux.zip
        chmod +x activator
        chmod +x upx
        
        # è®¾ç½®åº“è·¯å¾„
        export LD_LIBRARY_PATH=$PWD:$LD_LIBRARY_PATH
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p patched_files
    
    - name: Process IPK files
      run: |
        # è®¾ç½®å˜é‡
        SN="${{ github.event.inputs.serial_number }}"
        DEVICES="${{ github.event.inputs.device_count }}"
        
        echo "========================================="
        echo "Serial Number: $SN"
        echo "Device Count: $DEVICES"
        echo "========================================="
        
        # å¯¼å‡ºçŽ¯å¢ƒå˜é‡
        export LD_LIBRARY_PATH=$PWD:$LD_LIBRARY_PATH
        
        # ç”¨äºŽå­˜å‚¨ç¬¬ä¸€æ¬¡æˆåŠŸçš„License
        LICENSE_KEY=""
        
        # å¤„ç†æ¯ä¸ªIPKæ–‡ä»¶
        for ipk_file in ipk/*.ipk; do
          if [ -f "$ipk_file" ]; then
            echo ""
            echo "========================================="
            echo "Processing: $ipk_file"
            echo "========================================="
            
            # èŽ·å–æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„ï¼‰
            filename=$(basename "$ipk_file")
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•
            temp_dir="temp_work"
            rm -rf "$temp_dir"
            mkdir -p "$temp_dir"
            
            # è§£åŽ‹IPKæ–‡ä»¶
            echo "Step 1: Extracting IPK file..."
            
            # å°è¯•tar.gzæ ¼å¼
            if tar -xzf "$ipk_file" -C "$temp_dir" 2>/dev/null; then
              echo "Extracted as tar.gz format"
            # å°è¯•aræ ¼å¼ï¼ˆOpenWrt ipkï¼‰
            elif ar -x "$ipk_file" 2>/dev/null; then
              echo "Extracted as ar format"
              # è§£åŽ‹data.tar.gzåˆ°temp_dir
              if [ -f "data.tar.gz" ]; then
                tar -xzf data.tar.gz -C "$temp_dir"
                rm -f control.tar.gz data.tar.gz debian-binary
              fi
            # å°è¯•æ™®é€štar
            elif tar -xf "$ipk_file" -C "$temp_dir" 2>/dev/null; then
              echo "Extracted as tar format"
            else
              echo "Warning: Could not extract $ipk_file, skipping..."
              continue
            fi
            
            # æŸ¥æ‰¾vhusbdäºŒè¿›åˆ¶æ–‡ä»¶
            echo "Step 2: Looking for vhusbd binary..."
            VHUSBD_FILE=$(find "$temp_dir" -type f \( -name "vhusbd" -o -name "vhusbdarm" -o -name "vhusbdmipsel" -o -name "vhusbdmips" -o -name "vhusbdi386" -o -name "vhusbdx86_64" \) ! -name "*.exe" | head -1)
            
            if [ -z "$VHUSBD_FILE" ]; then
              echo "No vhusbd binary found in $ipk_file, skipping..."
              rm -rf "$temp_dir"
              continue
            fi
            
            echo "Found binary: $VHUSBD_FILE"
            
            # æ­¥éª¤1: ç”¨UPXè§£åŽ‹äºŒè¿›åˆ¶æ–‡ä»¶
            echo ""
            echo "Step 3: Unpacking binary with UPX..."
            echo "Command: upx -d $VHUSBD_FILE"
            ./upx -d "$VHUSBD_FILE" 2>&1 || echo "Note: Binary may not be UPX packed, continuing..."
            
            # æ­¥éª¤3: ç”¨activatoræ‰“è¡¥ä¸
            echo ""
            echo "Step 4: Patching with activator..."
            echo "Command: activator $VHUSBD_FILE $DEVICES $SN"
            echo "----------------------------------------"
            
            # è¿è¡Œactivatorå¹¶æ•èŽ·è¾“å‡º
            ACTIVATOR_OUTPUT=$(./activator "$VHUSBD_FILE" "$DEVICES" "$SN" 2>&1)
            echo "$ACTIVATOR_OUTPUT"
            echo "----------------------------------------"
            
            # ä»Žè¾“å‡ºä¸­æå–Licenseï¼ˆä¿®å¤çš„éƒ¨åˆ†ï¼‰
            if [ -z "$LICENSE_KEY" ]; then
              # æŸ¥æ‰¾åŒ…å«License=çš„è¡Œï¼ˆä¸é™äºŽè¡Œé¦–ï¼‰
              LICENSE_LINE=$(echo "$ACTIVATOR_OUTPUT" | grep "License=" | head -1)
              if [ -n "$LICENSE_LINE" ]; then
                # æå–License=åŽé¢çš„å†…å®¹
                LICENSE_KEY=$(echo "$LICENSE_LINE" | sed 's/.*License=//')
                
                # æ¸…ç†å¯èƒ½çš„ç©ºæ ¼
                LICENSE_KEY=$(echo "$LICENSE_KEY" | tr -d ' \r')
                
                echo ""
                echo ">>> Extracted License Key: $LICENSE_KEY"
                echo ""
                
                # ä¿å­˜Licenseåˆ°æ–‡ä»¶
                echo "$LICENSE_KEY" > "patched_files/${SN}_license.txt"
                
                # åˆ›å»ºè¯¦ç»†è¯´æ˜Žæ–‡ä»¶
                cat > "patched_files/README_${SN}.txt" << EOF
VirtualHere USB Server - Patched Version
=========================================

Serial Number: $SN
Device Count: $DEVICES
License Key: $LICENSE_KEY

Installation Instructions:
--------------------------
1. Install the patched IPK file (${SN}${filename}) on your device
2. Start the VirtualHere USB server
3. In VirtualHere Client:
   - Go to USB Servers -> License -> Enter Key
   - Enter this key: $LICENSE_KEY
4. You should see: USB Hub,s/n=$SN,$DEVICES devices

Note: If devices require authorization after activation, 
      try reducing the device count.

Patch Details:
--------------
$ACTIVATOR_OUTPUT
EOF
              else
                echo "No License line found in activator output"
              fi
            fi
            
            # æ£€æŸ¥è¡¥ä¸æ˜¯å¦æˆåŠŸ
            if echo "$ACTIVATOR_OUTPUT" | grep -q "patched"; then
              echo ""
              echo "Step 5: Patch successful, repacking with UPX..."
              echo "Command: upx -9 $VHUSBD_FILE"
              ./upx -9 "$VHUSBD_FILE" 2>&1 || echo "Note: Compression skipped"
            else
              echo "Warning: Patch may have failed, check the output above"
            fi
            
            # é‡æ–°æ‰“åŒ…IPKæ–‡ä»¶
            echo ""
            echo "Step 6: Repacking IPK file..."
            cd "$temp_dir"
            
            # æ ¹æ®åŽŸå§‹æ ¼å¼é‡æ–°æ‰“åŒ…
            OUTPUT_FILE="../patched_files/${SN}${filename}"
            
            # å°è¯•åˆ›å»ºtar.gzæ ¼å¼
            if tar -czf "$OUTPUT_FILE" . 2>/dev/null; then
              echo "Repacked as tar.gz: ${SN}${filename}"
            else
              echo "Failed to repack, trying zip format..."
              zip -r "$OUTPUT_FILE" . >/dev/null 2>&1
            fi
            
            cd ..
            
            # æ¸…ç†
            rm -rf "$temp_dir"
            
            echo ""
            echo "Completed: ${SN}${filename}"
            echo "========================================="
          fi
        done
        
        # æœ€ç»ˆæŠ¥å‘Š
        echo ""
        echo "========================================="
        echo "FINAL SUMMARY"
        echo "========================================="
        echo "Processed files:"
        ls -la patched_files/
        
        if [ -f "patched_files/${SN}_license.txt" ]; then
          echo ""
          echo "License Key saved in: ${SN}_license.txt"
          echo "License Key content:"
          cat "patched_files/${SN}_license.txt"
        else
          echo ""
          echo "WARNING: No license key was extracted!"
          echo "Please check the activator output above for errors."
        fi
    
    - name: Verify files before upload
      run: |
        SN="${{ github.event.inputs.serial_number }}"
        
        # ç¡®ä¿è‡³å°‘æœ‰ä¸€äº›å†…å®¹
        if [ ! -f "patched_files/${SN}_license.txt" ]; then
          echo "Creating placeholder license file..."
          echo "No license extracted - check manual patch output" > "patched_files/${SN}_license.txt"
        fi
        
        # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶åŠå¤§å°
        echo "Files to upload:"
        for f in patched_files/*; do
          if [ -f "$f" ]; then
            size=$(stat -c%s "$f" 2>/dev/null || wc -c < "$f")
            echo "  $(basename "$f") - Size: $size bytes"
          fi
        done
    
    - name: Upload patched files
      uses: actions/upload-artifact@v4
      with:
        name: patched-virtualhere-${{ github.event.inputs.serial_number }}
        path: patched_files/*
        retention-days: 30
    
    - name: Create Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: patch-${{ github.event.inputs.serial_number }}-${{ github.run_number }}
        name: VirtualHere Patched - ${{ github.event.inputs.serial_number }}
        body: |
          ## VirtualHere USB Server - Patched
          
          **Serial Number:** `${{ github.event.inputs.serial_number }}`  
          **Device Count:** `${{ github.event.inputs.device_count }}`
          
          ### ðŸ“¦ Files
          - Patched IPK files: `${{ github.event.inputs.serial_number }}*.ipk`
          - License key: `${{ github.event.inputs.serial_number }}_license.txt`
          - Instructions: `README_${{ github.event.inputs.serial_number }}.txt`
          
          ### ðŸ”§ Installation
          1. Download and install the patched IPK file
          2. Check the license.txt file for your key
          3. Enter the key in VirtualHere Client: USB Servers â†’ License â†’ Enter Key
          
          ### âš ï¸ Notes
          - The license key format: `serialnumber,devices,activation_code`
          - If devices require authorization, reduce the device count
        files: patched_files/*
        fail_on_unmatched_files: false
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
