name: ğŸ› ï¸ Build Patched VirtualHere IPKs (All Architectures)

on:
  workflow_dispatch:
    inputs:
      serial_number:
        description: 'Serial Number (SN) from your VirtualHere client'
        required: true
        type: string
        placeholder: 'Paste the s/n= value from your client here'
      device_count:
        description: 'Number of devices to activate (1-64)'
        required: true
        type: number
        default: 63
        min: 1
        max: 64

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Unpack Tools
        run: |
          # è§£å‹ä½ ä¸Šä¼ çš„ activator_linux.zip
          unzip activator_linux.zip -d tools/
          # ç¡®ä¿å·¥å…·å…·æœ‰å¯æ‰§è¡Œæƒé™
          chmod +x tools/upx tools/activator

      - name: ğŸ“‹ List Available IPK Files
        run: |
          echo "Found the following IPK files to patch:"
          ls -la ipk/*.ipk || echo "No IPK files found in ipk/ directory"

      - name: ğŸ”¨ Process All IPK Files
        run: |
          # éå† ipk/ ç›®å½•ä¸‹çš„æ‰€æœ‰ .ipk æ–‡ä»¶
          for ORIGINAL_IPK in ipk/*.ipk; do
            # è·å–ä¸å¸¦è·¯å¾„çš„æ–‡ä»¶å
            BASE_IPK_NAME=$(basename "$ORIGINAL_IPK")
            # æ–° IPK çš„åç§°æ ¼å¼ï¼š{SN}{original_ipk_name}
            NEW_IPK="${{ inputs.serial_number }}${BASE_IPK_NAME}"
            
            echo "----------------------------------------------------------"
            echo "ğŸ”§ Processing: $BASE_IPK_NAME -> $NEW_IPK"
            echo "----------------------------------------------------------"

            # 1. åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
            WORK_DIR=$(mktemp -d)
            cd "$WORK_DIR"
            
            # 2. å¤åˆ¶åŸå§‹ IPK åˆ°ä¸´æ—¶ç›®å½•
            cp "../../$ORIGINAL_IPK" ./

            # 3. è§£å‹åŸå§‹ IPK
            mkdir extracted_ipk
            tar -xzf "$BASE_IPK_NAME" -C extracted_ipk/

            # 4. è§£å‹ data.tar.gz
            cd extracted_ipk
            tar -xzf data.tar.gz

            # 5. æ‰¾åˆ° vhusbd äºŒè¿›åˆ¶æ–‡ä»¶
            VHUSBD_PATH=$(find . -name "vhusbd*" -type f -executable | head -n 1)
            if [ -z "$VHUSBD_PATH" ]; then
              echo "âŒ Error: Could not find vhusbd binary in $BASE_IPK_NAME"
              continue
            fi
            echo "Found vhusbd at: $VHUSBD_PATH"

            # 6. å°è¯•ç”¨ UPX è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶
            cd ../..
            ./tools/upx -d "$WORK_DIR/extracted_ipk/$VHUSBD_PATH" || echo "Binary not packed with UPX, continuing..."

            # 7. ä½¿ç”¨ activator ç ´è§£äºŒè¿›åˆ¶æ–‡ä»¶
            echo "Patching binary with SN: ${{ inputs.serial_number }}"
            ./tools/activator "$WORK_DIR/extracted_ipk/$VHUSBD_PATH" ${{ inputs.device_count }} ${{ inputs.serial_number }}

            # 8. (å¯é€‰) é‡æ–°ç”¨ UPX å‹ç¼©
            ./tools/upx -9 "$WORK_DIR/extracted_ipk/$VHUSBD_PATH" || echo "UPX re-compression failed or skipped, continuing..."

            # 9. é‡æ–°æ‰“åŒ… data.tar.gz
            cd "$WORK_DIR/extracted_ipk"
            tar -czf ../new_data.tar.gz ./*

            # 10. æ›¿æ¢æ—§çš„ data.tar.gz
            cd ..
            cp new_data.tar.gz extracted_ipk/data.tar.gz

            # 11. é‡æ–°æ‰“åŒ…æ•´ä¸ª IPK
            cd extracted_ipk
            tar -czf "../../$NEW_IPK" ./*

            # 12. æ¸…ç†ä¸´æ—¶å·¥ä½œç›®å½•
            cd ../..
            rm -rf "$WORK_DIR"
            
            echo "âœ… Successfully created: $NEW_IPK"
            echo ""

          done

      - name: ğŸ“¤ Upload All Patched IPKs
        uses: actions/upload-artifact@v4
        with:
          name: patched-ipks-${{ inputs.serial_number }}
          path: ${{ inputs.serial_number }}*.ipk
          # ä¸Šä¼ æ‰€æœ‰ä»¥ SN å¼€å¤´çš„ IPK æ–‡ä»¶

      - name: âœ… Completion Message
        run: |
          echo "=========================================================="
          echo "âœ… Build successful! All IPK files have been processed."
          echo "ğŸ“¦ Generated files:"
          ls -la ${{ inputs.serial_number }}*.ipk || echo "No files found"
          echo ""
          echo "ğŸ”‘ Please use the following license key in your client:"
          echo "   ${{ inputs.serial_number }},${{ inputs.device_count }},XXXXXXXXXXXX"
          echo "=========================================================="
