name: Patch VirtualHere USB Server

on:
  workflow_dispatch:
    inputs:
      serial_number:
        description: 'Serial Number (e.g., 123456789abcdef)'
        required: true
        type: string
      device_count:
        description: 'Number of devices (1-64)'
        required: false
        default: '63'
        type: string

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  patch-and-upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        # Ëß£ÂéãÂ∑•ÂÖ∑ÂåÖ
        unzip activator_linux.zip
        chmod +x activator
        chmod +x upx
        
        # ËÆæÁΩÆÂ∫ìË∑ØÂæÑ
        export LD_LIBRARY_PATH=$PWD:$LD_LIBRARY_PATH
        
        # ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
        mkdir -p patched_files
    
    - name: Process IPK files
      run: |
        # ËÆæÁΩÆÂèòÈáè
        SN="${{ github.event.inputs.serial_number }}"
        DEVICES="${{ github.event.inputs.device_count }}"
        
        echo "========================================="
        echo "Serial Number: $SN"
        echo "Device Count: $DEVICES"
        echo "========================================="
        
        # ÂØºÂá∫ÁéØÂ¢ÉÂèòÈáè
        export LD_LIBRARY_PATH=$PWD:$LD_LIBRARY_PATH
        
        # Áî®‰∫éÂ≠òÂÇ®Á¨¨‰∏ÄÊ¨°ÊàêÂäüÁöÑLicense
        LICENSE_KEY=""
        
        # Â§ÑÁêÜÊØè‰∏™IPKÊñá‰ª∂
        for ipk_file in ipk/*.ipk; do
          if [ -f "$ipk_file" ]; then
            echo ""
            echo "========================================="
            echo "Processing: $ipk_file"
            echo "========================================="
            
            # Ëé∑ÂèñÊñá‰ª∂ÂêçÔºà‰∏çÂê´Ë∑ØÂæÑÔºâ
            filename=$(basename "$ipk_file")
            
            # ÂàõÂª∫‰∏¥Êó∂ÁõÆÂΩï
            temp_dir="temp_work"
            rm -rf "$temp_dir"
            mkdir -p "$temp_dir"
            
            # Ëß£ÂéãIPKÊñá‰ª∂
            echo "Step 1: Extracting IPK file..."
            
            # Â∞ùËØïtar.gzÊ†ºÂºè
            if tar -xzf "$ipk_file" -C "$temp_dir" 2>/dev/null; then
              echo "Extracted as tar.gz format"
            # Â∞ùËØïarÊ†ºÂºèÔºàOpenWrt ipkÔºâ
            elif ar -x "$ipk_file" 2>/dev/null; then
              echo "Extracted as ar format"
              # Ëß£Âéãdata.tar.gzÂà∞temp_dir
              if [ -f "data.tar.gz" ]; then
                tar -xzf data.tar.gz -C "$temp_dir"
                rm -f control.tar.gz data.tar.gz debian-binary
              fi
            # Â∞ùËØïÊôÆÈÄötar
            elif tar -xf "$ipk_file" -C "$temp_dir" 2>/dev/null; then
              echo "Extracted as tar format"
            else
              echo "Warning: Could not extract $ipk_file, skipping..."
              continue
            fi
            
            # Êü•Êâævhusbd‰∫åËøõÂà∂Êñá‰ª∂
            echo "Step 2: Looking for vhusbd binary..."
            VHUSBD_FILE=$(find "$temp_dir" -type f KATEX_INLINE_OPEN -name "vhusbd" -o -name "vhusbdarm" -o -name "vhusbdmipsel" -o -name "vhusbdmips" -o -name "vhusbdi386" -o -name "vhusbdx86_64" KATEX_INLINE_CLOSE ! -name "*.exe" | head -1)
            
            if [ -z "$VHUSBD_FILE" ]; then
              echo "No vhusbd binary found in $ipk_file, skipping..."
              rm -rf "$temp_dir"
              continue
            fi
            
            echo "Found binary: $VHUSBD_FILE"
            
            # Ê≠•È™§1: Áî®UPXËß£Âéã‰∫åËøõÂà∂Êñá‰ª∂
            echo ""
            echo "Step 3: Unpacking binary with UPX..."
            echo "Command: upx -d $VHUSBD_FILE"
            ./upx -d "$VHUSBD_FILE" 2>&1 || echo "Note: Binary may not be UPX packed, continuing..."
            
            # Ê≠•È™§3: Áî®activatorÊâìË°•‰∏Å
            echo ""
            echo "Step 4: Patching with activator..."
            echo "Command: activator $VHUSBD_FILE $DEVICES $SN"
            echo "----------------------------------------"
            
            # ËøêË°åactivatorÂπ∂ÊçïËé∑ËæìÂá∫
            ACTIVATOR_OUTPUT=$(./activator "$VHUSBD_FILE" "$DEVICES" "$SN" 2>&1)
            echo "$ACTIVATOR_OUTPUT"
            echo "----------------------------------------"
            
            # ‰ªéËæìÂá∫‰∏≠ÊèêÂèñLicense
            if [ -z "$LICENSE_KEY" ]; then
              # Êü•ÊâæLicense=ÂºÄÂ§¥ÁöÑË°å
              LICENSE_LINE=$(echo "$ACTIVATOR_OUTPUT" | grep "^License=")
              if [ -n "$LICENSE_LINE" ]; then
                # ÊèêÂèñÂÆåÊï¥ÁöÑLicenseÂÄºÔºàÊ†ºÂºè: serial,devices,keyÔºâ
                LICENSE_KEY=$(echo "$LICENSE_LINE" | cut -d'=' -f2)
                echo ""
                echo ">>> Extracted License Key: $LICENSE_KEY"
                echo ""
                
                # ‰øùÂ≠òLicenseÂà∞Êñá‰ª∂
                echo "$LICENSE_KEY" > "patched_files/${SN}_license.txt"
                
                # ÂàõÂª∫ËØ¶ÁªÜËØ¥ÊòéÊñá‰ª∂
                cat > "patched_files/README_${SN}.txt" << EOF
VirtualHere USB Server - Patched Version
=========================================

Serial Number: $SN
Device Count: $DEVICES
License Key: $LICENSE_KEY

Installation Instructions:
--------------------------
1. Install the patched IPK file (${SN}${filename}) on your device
2. Start the VirtualHere USB server
3. In VirtualHere Client:
   - Go to USB Servers -> License -> Enter Key
   - Enter this key: $LICENSE_KEY
4. You should see: USB Hub,s/n=$SN,$DEVICES devices

Note: If devices require authorization after activation, 
      try reducing the device count.

Patch Details:
--------------
$ACTIVATOR_OUTPUT
EOF
              fi
            fi
            
            # Ê£ÄÊü•Ë°•‰∏ÅÊòØÂê¶ÊàêÂäü
            if echo "$ACTIVATOR_OUTPUT" | grep -q "patched"; then
              echo ""
              echo "Step 5: Patch successful, repacking with UPX..."
              echo "Command: upx -9 $VHUSBD_FILE"
              ./upx -9 "$VHUSBD_FILE" 2>&1 || echo "Note: Compression skipped"
            else
              echo "Warning: Patch may have failed, check the output above"
            fi
            
            # ÈáçÊñ∞ÊâìÂåÖIPKÊñá‰ª∂
            echo ""
            echo "Step 6: Repacking IPK file..."
            cd "$temp_dir"
            
            # Ê†πÊçÆÂéüÂßãÊ†ºÂºèÈáçÊñ∞ÊâìÂåÖ
            OUTPUT_FILE="../patched_files/${SN}${filename}"
            
            # Â∞ùËØïÂàõÂª∫tar.gzÊ†ºÂºè
            if tar -czf "$OUTPUT_FILE" * 2>/dev/null; then
              echo "Repacked as tar.gz: ${SN}${filename}"
            else
              echo "Failed to repack, trying zip format..."
              zip -r "$OUTPUT_FILE" * >/dev/null 2>&1
            fi
            
            cd ..
            
            # Ê∏ÖÁêÜ
            rm -rf "$temp_dir"
            
            echo ""
            echo "Completed: ${SN}${filename}"
            echo "========================================="
          fi
        done
        
        # ÊúÄÁªàÊä•Âëä
        echo ""
        echo "========================================="
        echo "FINAL SUMMARY"
        echo "========================================="
        echo "Processed files:"
        ls -la patched_files/
        
        if [ -f "patched_files/${SN}_license.txt" ]; then
          echo ""
          echo "License Key saved in: ${SN}_license.txt"
          echo "License Key content:"
          cat "patched_files/${SN}_license.txt"
        else
          echo ""
          echo "WARNING: No license key was extracted!"
          echo "Please check the activator output above for errors."
        fi
    
    - name: Verify files before upload
      run: |
        SN="${{ github.event.inputs.serial_number }}"
        
        # Á°Æ‰øùËá≥Â∞ëÊúâ‰∏Ä‰∫õÂÜÖÂÆπ
        if [ ! -f "patched_files/${SN}_license.txt" ]; then
          echo "Creating placeholder license file..."
          echo "No license extracted - check manual patch output" > "patched_files/${SN}_license.txt"
        fi
        
        # ÂàóÂá∫ÊâÄÊúâÊñá‰ª∂ÂèäÂ§ßÂ∞è
        echo "Files to upload:"
        for f in patched_files/*; do
          if [ -f "$f" ]; then
            size=$(stat -f%z "$f" 2>/dev/null || stat -c%s "$f" 2>/dev/null || echo "unknown")
            echo "  $(basename "$f") - Size: $size bytes"
          fi
        done
    
    - name: Upload patched files
      uses: actions/upload-artifact@v4
      with:
        name: patched-virtualhere-${{ github.event.inputs.serial_number }}
        path: patched_files/*
        retention-days: 30
    
    - name: Create Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: patch-${{ github.event.inputs.serial_number }}-${{ github.run_number }}
        name: VirtualHere Patched - ${{ github.event.inputs.serial_number }}
        body: |
          ## VirtualHere USB Server - Patched
          
          **Serial Number:** `${{ github.event.inputs.serial_number }}`  
          **Device Count:** `${{ github.event.inputs.device_count }}`
          
          ### üì¶ Files
          - Patched IPK files: `${{ github.event.inputs.serial_number }}*.ipk`
          - License key: `${{ github.event.inputs.serial_number }}_license.txt`
          - Instructions: `README_${{ github.event.inputs.serial_number }}.txt`
          
          ### üîß Installation
          1. Download and install the patched IPK file
          2. Check the license.txt file for your key
          3. Enter the key in VirtualHere Client: USB Servers ‚Üí License ‚Üí Enter Key
          
          ### ‚ö†Ô∏è Notes
          - The license key format: `serialnumber,devices,activation_code`
          - If devices require authorization, reduce the device count
        files: patched_files/*
        fail_on_unmatched_files: false
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
