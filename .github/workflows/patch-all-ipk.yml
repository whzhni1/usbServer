name: ðŸ› ï¸ Build Patched VirtualHere IPKs (All Architectures)

on:
  workflow_dispatch:
    inputs:
      serial_number:
        description: 'Serial Number (SN) from your VirtualHere client'
        required: true
        type: string
        placeholder: 'Paste the s/n= value from your client here'
      device_count:
        description: 'Number of devices to activate (1-64)'
        required: true
        type: number
        default: 63
        min: 1
        max: 64

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›Žï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Unpack Tools
        run: |
          unzip activator_linux.zip -d tools/
          chmod +x tools/upx tools/activator
          chmod +r tools/libcrypto.so.1.1

      - name: ðŸ“‹ List Available IPK Files
        run: |
          echo "Found the following IPK files to patch:"
          ls -la ipk/*.ipk || echo "No IPK files found in ipk/ directory"

      - name: ðŸ”¨ Process All IPK Files
        run: |
          # è®¾ç½®åº“è·¯å¾„ï¼Œè®© activator èƒ½æ‰¾åˆ° libcrypto.so.1.1
          export LD_LIBRARY_PATH=$GITHUB_WORKSPACE/tools:$LD_LIBRARY_PATH
          echo "LD_LIBRARY_PATH set to: $LD_LIBRARY_PATH"
          
          # éåŽ† ipk/ ç›®å½•ä¸‹çš„æ‰€æœ‰ .ipk æ–‡ä»¶
          for ORIGINAL_IPK in ipk/*.ipk; do
            BASE_IPK_NAME=$(basename "$ORIGINAL_IPK")
            NEW_IPK="${{ inputs.serial_number }}${BASE_IPK_NAME}"
            
            echo "----------------------------------------------------------"
            echo "ðŸ”§ Processing: $BASE_IPK_NAME -> $NEW_IPK"
            echo "----------------------------------------------------------"

            WORK_DIR=$(mktemp -d)
            cd "$WORK_DIR"
            
            # å¤åˆ¶åŽŸå§‹ IPK åˆ°ä¸´æ—¶ç›®å½•
            cp "$GITHUB_WORKSPACE/$ORIGINAL_IPK" ./

            # è§£åŽ‹åŽŸå§‹ IPK
            mkdir extracted_ipk
            tar -xzf "$BASE_IPK_NAME" -C extracted_ipk/

            # è§£åŽ‹ data.tar.gz
            cd extracted_ipk
            tar -xzf data.tar.gz

            # æŸ¥æ‰¾æ‰€æœ‰ vhusbd æ–‡ä»¶ï¼ˆåŒ…æ‹¬æ²¡æœ‰æ‰§è¡Œæƒé™çš„ï¼‰
            echo "Searching for all vhusbd files..."
            VHUSBD_FILES=$(find . -name "vhusbd" -type f)
            
            if [ -z "$VHUSBD_FILES" ]; then
              echo "âŒ Error: Could not find any vhusbd files in $BASE_IPK_NAME"
              cd "$GITHUB_WORKSPACE"
              rm -rf "$WORK_DIR"
              continue
            fi
            
            # æ˜¾ç¤ºæ‰¾åˆ°çš„æ‰€æœ‰æ–‡ä»¶
            echo "Found vhusbd files:"
            echo "$VHUSBD_FILES"
            
            # æ ‡è®°æ˜¯å¦æˆåŠŸå¤„ç†äº†è‡³å°‘ä¸€ä¸ªæ–‡ä»¶
            PATCH_SUCCESS=false
            
            # éåŽ†æ‰¾åˆ°çš„æ¯ä¸ª vhusbd æ–‡ä»¶å¹¶è¿›è¡Œå¤„ç†
            for VHUSBD_PATH in $VHUSBD_FILES; do
              # è·³è¿‡è„šæœ¬æ–‡ä»¶ï¼ˆæ ¹æ®è·¯å¾„åˆ¤æ–­ï¼‰
              if [[ "$VHUSBD_PATH" == *"/etc/"* ]] || [[ "$VHUSBD_PATH" == *"/init.d/"* ]]; then
                echo "â­ï¸  Skipping script file: $VHUSBD_PATH"
                continue
              fi
              
              echo "âœ… Processing vhusbd at: $VHUSBD_PATH"
              echo "File info:"
              file "$VHUSBD_PATH"
              ls -la "$VHUSBD_PATH"
              
              # ç»™æ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™
              chmod +x "$VHUSBD_PATH"
              echo "Added execute permission to file"

              # å›žåˆ°ä»“åº“æ ¹ç›®å½•ä½¿ç”¨å·¥å…·
              cd "$GITHUB_WORKSPACE"
              
              # å°è¯•ç”¨ UPX è§£åŽ‹äºŒè¿›åˆ¶æ–‡ä»¶
              echo "Attempting to decompress with UPX..."
              ./tools/upx -d "$WORK_DIR/$VHUSBD_PATH" || echo "UPX decompression failed or not needed, continuing..."

              # ä½¿ç”¨ activator ç ´è§£äºŒè¿›åˆ¶æ–‡ä»¶
              echo "Patching binary with SN: ${{ inputs.serial_number }} and device count: ${{ inputs.device_count }}"
              ./tools/activator "$WORK_DIR/$VHUSBD_PATH" ${{ inputs.device_count }} ${{ inputs.serial_number }}
              
              if [ $? -eq 0 ]; then
                echo "âœ… Binary patched successfully"
                PATCH_SUCCESS=true
                
                # é‡æ–°ç”¨ UPX åŽ‹ç¼©
                echo "Re-compressing with UPX..."
                ./tools/upx -9 "$WORK_DIR/$VHUSBD_PATH" || echo "UPX re-compression failed or skipped, continuing..."

                # é‡æ–°æ‰“åŒ… data.tar.gz
                cd "$WORK_DIR/extracted_ipk"
                tar -czf ../new_data.tar.gz ./*

                # æ›¿æ¢æ—§çš„ data.tar.gz
                cd ..
                cp new_data.tar.gz extracted_ipk/data.tar.gz

                # é‡æ–°æ‰“åŒ…æ•´ä¸ª IPK
                cd extracted_ipk
                tar -czf "$GITHUB_WORKSPACE/$NEW_IPK" ./*

                echo "âœ… Successfully created patched IPK: $NEW_IPK"
                break # å¤„ç†ä¸€ä¸ªæˆåŠŸçš„æ–‡ä»¶åŽå°±è·³å‡ºå¾ªçŽ¯
              else
                echo "âŒ Binary patching failed with error code: $?"
                # ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªæ–‡ä»¶
                cd "$WORK_DIR/extracted_ipk"
              fi
            done

            if [ "$PATCH_SUCCESS" = false ]; then
              echo "âŒ Failed to patch any vhusbd binary in $BASE_IPK_NAME"
            fi

            # æ¸…ç†ä¸´æ—¶å·¥ä½œç›®å½•
            cd "$GITHUB_WORKSPACE"
            rm -rf "$WORK_DIR"
            
            echo ""

          done

      - name: ðŸ“¤ Upload All Patched IPKs
        uses: actions/upload-artifact@v4
        with:
          name: patched-ipks-${{ inputs.serial_number }}
          path: ${{ inputs.serial_number }}*.ipk

      - name: âœ… Completion Message
        run: |
          echo "=========================================================="
          echo "âœ… Build completed!"
          echo "ðŸ“¦ Generated files:"
          ls -la ${{ inputs.serial_number }}*.ipk 2>/dev/null || echo "No IPK files were generated"
          echo ""
          echo "ðŸ”‘ Please use the following license key in your VirtualHere client:"
          echo "   ${{ inputs.serial_number }},${{ inputs.device_count }},XXXXXXXXXXXX"
          echo ""
          echo "ðŸ“– Installation:"
          echo "   1. Download the patched IPK file from Artifacts above"
          echo "   2. Upload and install it on your OpenWrt device"
          echo "   3. Enter the license key in your VirtualHere client"
          echo "=========================================================="
